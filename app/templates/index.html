<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intermagnet Data Scrape</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #f8f9fa;
            text-align: center;
        }
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="message" class="text-center my-4">{{ message }}</h1>

        <!-- Formular für Start- und Endzeit -->
        <form method="POST" class="mb-4">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="station">Stationen (Komma getrennt):</label>
                    <input type="text" class="form-control" id="station" name="station" placeholder="z.B. NGK, ESK, WNG">
                </div>
                <div class="form-group col-md-3">
                    <label for="distance">Abstand zur Station BUE auf dem Breitengrad:</label>
                    <input type="number" class="form-control" id="distance" name="distance" value="2">
                </div>
                <div class="form-group col-md-3">
                    <label for="start">Startzeit:</label>
                    <input type="datetime-local" class="form-control" id="start" name="start" value="{{ start or '2024-09-01T00:00' }}" required>
                </div>
                <div class="form-group col-md-3">
                    <label for="stop">Endzeit:</label>
                    <input type="datetime-local" class="form-control" id="stop" name="stop" value="{{ stop or '2024-10-01T00:00' }}" required>
                </div>
                <div class="form-group col-md-3">
                    <label for="threshold">Schwellenwert (nT):</label>
                    <input type="number" class="form-control" id="threshold" name="threshold" value="100000" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Daten abrufen und plotten</button>
        </form>

        <div class="text-center my-4">
            <button id="select-default" class="btn btn-secondary">Standardstationen auswählen</button>
        </div>

        <div id="progress-container" class="text-center my-4" style="display: none;">
            <h2>Fortschritt: <span id="progress">0</span>%</h2>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <h3>Geschätzte verbleibende Zeit: <span id="remaining-time">0</span> Sekunden</h3>
        </div>

        {% if plot_url %}
            <h2 class="text-center my-4">Plot für die Zeitspanne von {{ start|datetimeformat }} bis {{ stop|datetimeformat }}:</h2>
            <!-- Einbetten des interaktiven Plots -->
            <iframe src="{{ url_for('download_file', filename=plot_url) }}" width="100%" height="600" class="mb-4"></iframe>

            <!-- Download-Link für den Plot -->
            <div class="text-center">
                <a href="{{ url_for('download_file', filename=plot_url) }}" class="btn btn-secondary" download>Plot herunterladen</a>
            </div>
        {% endif %}

        {% if plot_changes_url %}
            <h2 class="text-center my-4">Veränderungen des Magnetfeldes von {{ start|datetimeformat }} bis {{ stop|datetimeformat }}:</h2>
            <!-- Einbetten des interaktiven Plots -->
            <iframe src="{{ url_for('download_file', filename=plot_changes_url) }}" width="100%" height="600" class="mb-4"></iframe>

            <!-- Download-Link für den Plot -->
            <div class="text-center">
                <a href="{{ url_for('download_file', filename=plot_changes_url) }}" class="btn btn-secondary" download>Plot herunterladen</a>
            </div>
        {% endif %}

        {% if map_plot_url %}
            <h2 class="text-center my-4">Weltkarte der ausgewählten Stationen:</h2>
            <!-- Leaflet-Karte -->
            <div id="map"></div>

            <!-- Download-Link für die Weltkarte -->
            <div class="text-center">
                <a href="{{ url_for('download_file', filename=map_plot_url) }}" class="btn btn-secondary" download>Weltkarte herunterladen</a>
            </div>
        {% endif %}

        {% if csv_url %}
            <h2 class="text-center my-4">CSV-Datei der kombinierten Daten:</h2>
            <div class="text-center">
                <a href="{{ url_for('download_file', filename=csv_url) }}" class="btn btn-secondary" download>CSV herunterladen</a>
            </div>
        {% endif %}

        {% if stations %}
            <h2 class="text-center my-4">Ausgewählte Stationen:</h2>
            <ul class="list-group">
                {% for station in stations %}
                    <li class="list-group-item">{{ station }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        {% if filtered_data_info %}
            <h2 class="text-center my-4">
                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#filteredDataCollapse" aria-expanded="false" aria-controls="filteredDataCollapse">
                    Gefilterte Datenpunkte (Anzahl: {{ filtered_data_info|length }})
                </button>
            </h2>
            <div class="collapse" id="filteredDataCollapse">
                <ul class="list-group">
                    {% for info in filtered_data_info %}
                        <li class="list-group-item">{{ info }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if correlation_matrix %}
            <h2 class="text-center my-4">Korrelationsmatrix:</h2>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Station</th>
                            {% for station in correlation_matrix.columns %}
                                <th>{{ station }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for station, row in correlation_matrix.iterrows() %}
                            <tr>
                                <td>{{ station }}</td>
                                {% for value in row %}
                                    <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

    <footer>
        <p>&copy; 2025 Florian von Bargen, API: R.S. Weigel</p>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Nachricht nach 5 Sekunden ausblenden
        setTimeout(function() {
            var messageElement = document.getElementById('message');
            if (messageElement) {
                messageElement.classList.add('fade-out');
            }
        }, 5000);

        // WebSocket-Verbindung herstellen
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        // Fortschritt anzeigen
        socket.on('progress', function(data) {
            var progressContainer = document.getElementById('progress-container');
            var progressElement = document.getElementById('progress');
            var progressBar = document.getElementById('progress-bar');
            var remainingTimeElement = document.getElementById('remaining-time');
            progressContainer.style.display = 'block';
            progressElement.innerText = data.progress;
            progressBar.style.width = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);
            remainingTimeElement.innerText = data.remaining_time;
        });

        // Standardstationen auswählen
        document.getElementById('select-default').addEventListener('click', function() {
            var selectElement = document.getElementById('station');
            var defaultStations = ['NGK', 'ESK', 'VAL', 'WNG', 'HLP', 'ARS'];
            for (var i = 0; i < selectElement.options.length; i++) {
                if (defaultStations.includes(selectElement.options[i].value)) {
                    selectElement.options[i].selected = true;
                } else {
                    selectElement.options[i].selected = false;
                }
            }
        });

        // Leaflet-Karte initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            {% if map_plot_url %}
            var map = L.map('map').setView([53.651, 9.424], 5);

            // Basiskarten
            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            // Standardmäßig die Satellitenansicht hinzufügen
            satellite.addTo(map);

            // Layer Control hinzufügen
            var baseMaps = {
                "Satellit": satellite,
                "Straßenkarte": streets
            };

            L.control.layers(baseMaps).addTo(map);

            fetch('{{ url_for("download_file", filename="combined/map_data.json") }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Netzwerkantwort war nicht ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (Array.isArray(data)) {
                        data.forEach(station => {
                            if (station.latitude !== undefined && station.longitude !== undefined) {
                                L.marker([station.latitude, station.longitude])
                                    .bindPopup(`<b>${station.observatory_name} (${station.iaga_code})</b>`)
                                    .addTo(map);
                                L.marker([station.latitude, station.longitude], {
                                    icon: L.divIcon({
                                        className: 'station-label',
                                        html: `<div style="color: blue; font-weight: bold;">${station.observatory_name} (${station.iaga_code})</div>`,
                                        iconSize: [0, 0]
                                    })
                                }).addTo(map);
                            }
                        });
                    } else {
                        console.error('Datenformat ist ungültig:', data);
                    }
                })
                .catch(error => console.error('Fehler beim Abrufen der Daten:', error));

            // Hinzufügen der Breitengrade 52, 53, 54, 55 und 56 mit Beschriftungen
            [52, 53, 54, 55, 56].forEach(lat => {
                L.polyline([[lat, -180], [lat, 180]], { color: 'green', weight: 2 }).addTo(map);
                L.marker([lat, 0], {
                    icon: L.divIcon({
                        className: 'latitude-label',
                        html: `<div style="color: green; font-weight: bold;">${lat}°</div>`,
                        iconSize: [0, 0]
                    })
                }).addTo(map);
            });
            {% endif %}
        });
    </script>
</body>
</html>